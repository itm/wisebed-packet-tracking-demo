<!DOCTYPE html >
<html>
<head>

	<meta charset="utf-8">

	<title>DDD - Dennis Dolle Demo</title>

	<link rel="stylesheet" media="screen" href="bootstrap.css">
	<style type="text/css">

		body {
			margin: 10px;
		}

		#DivPacketCount {
			position: absolute;
			background-color: black;
			color: white;
			top: 10px;
			right: 10px;
		}

		#DemoCanvas {
			background-size: 100% auto;
			background-image: url(floorplan_testbed_uzl.png);
			background-repeat: no-repeat;
			border: 1px solid black;
			width: 100%;
			height: 1000px;
		}

		rect {
			fill: none;
			pointer-events: all;
		}

		.node {
			fill: #000;
		}

		.cursor {
			fill: none;
			stroke: brown;
			pointer-events: none;
		}

		.link {
			stroke: #999;
		}

	</style>

	
	<script type="text/javascript" src="jquery-1.9.1.js"></script>
	<script type="text/javascript" src="bootstrap.js"></script>
	
	<script type="text/javascript" src="pt_packet.js"></script>
	<script type="text/javascript" src="wiseml.js"></script>
	<script src="http://d3js.org/d3.v3.min.js"></script>

	<script type="text/javascript">
		
		WiseGuiUserScript = function() {
			console.log("WiseGuiUserScript instantiated...");
			this.testbedId = null;
			this.experimentId = null;
			this.webSocket = null;
			this.outputDiv = null;
		};

		WiseGuiUserScript.prototype.start = function(env) {
			
			console.log("Starting user script...");

			this.testbedId = env.testbedId;
			this.experimentId = env.experimentId;
			this.outputDiv = env.outputDiv;

			var width = $('#DemoCanvas').width(), height = $('#DemoCanvas').height();

			var fill = d3.scale.category20();

			var force = d3.layout.force()
			    .size([width, height])
			    .nodes([]) // initialize with a single node
			    .linkDistance(30)
			    .charge(-60)
			    .on("tick", tick);

			var svg = d3.select("#DemoCanvas").append("svg")
			    .attr("width", width)
			    .attr("height", height);

			svg.append("rect")
			    .attr("width", width)
			    .attr("height", height);

			var nodes = force.nodes(),
			    links = force.links(),
			    node = svg.selectAll(".node"),
			    link = svg.selectAll(".link");

			var cursor = svg.append("circle")
			    .attr("r", 30)
			    .attr("transform", "translate(-100,-100)")
			    .attr("class", "cursor");

			this.svg = svg;
			this.force = force;
			this.nodes = nodes;
			this.links = links;
			this.node = node;
			this.link = link;

			this.redraw();

			var self = this;

			function tick() {
			  self.link
			      .attr("x1", function(d) { return d.source.x; })
			      .attr("y1", function(d) { return d.source.y; })
			      .attr("x2", function(d) { return d.target.x; })
			      .attr("y2", function(d) { return d.target.y; });

			  self.node
			      .attr("cx", function(d) { return d.x; })
			      .attr("cy", function(d) { return d.y; });
			}

			// TODO: load WiseML from testbed
			wiseml.setup.node
				.filter(function(node) { return node.nodeType == "isense48"; })
				.forEach(function(node) { self.addNode(node); });

			/*
			var self = this;
			this.webSocket = new Wisebed.WebSocket(
			  this.testbedId,
			  this.experimentId,
			  function() {self.onmessage(arguments);},
			  function() {self.onopen(arguments);},
			  function() {self.onclosed(arguments);}
			);
			*/
		};

		WiseGuiUserScript.prototype.redraw = function() {

			this.link = this.link.data(this.links);

			this.link
				.enter()
				.insert("line", ".node")
				.attr("class", "link");

			this.node = this.svg.selectAll(".node");
			this.node = this.node.data(this.nodes);

			this.node
				.enter()
				.insert("circle", ".cursor")
				.attr("class", "node")
				.attr("r", 15)
				.call(this.force.drag);

			this.force.start();
		}

		WiseGuiUserScript.prototype.mapPosXY = function(node) {
			return {
				x: node.position.x * 30,
				y: node.position.y * 30
			};
		}

		WiseGuiUserScript.prototype.addNode = function (sourceNode) {
			var pos = this.mapPosXY(sourceNode);
			var node = {x: pos.x, y: pos.y, fixed: true};
			this.nodes.push(node);
			this.redraw();
		}

		WiseGuiUserScript.prototype.addLink = function (sourceNode,targetNode) {
			
		}

		WiseGuiUserScript.prototype.removeLink = function (sourceNode,targetNode) {
			for(var i=0;i<links.length;i++) {
				if(links[i].source.id == source && links[i].target.id == target) {
					links.splice(i,1);
					break;
				}
			}
			update();
		};

		WiseGuiUserScript.prototype.stop = function() {
			console.log("Stopping user script...");
			//this.webSocket.close();
		};

		WiseGuiUserScript.prototype.onmessage = function(message) {
			var payload = new Uint8Array(atob(message.payloadBase64).split("").map(function(c) { return c.charCodeAt(0); }));
			var packet = PTPacket.parse(payload);
			console.log(packet.toString());
		};

		WiseGuiUserScript.prototype.onopen = function(event) {
			console.log(event);
		};

		WiseGuiUserScript.prototype.onclosed = function(event) {
			console.log(event);
		};

	</script>

	<script type="text/javascript">

		function sendPacket(userScript, srcNodeUrn, dstNodeUrn) {

			var payload = new Uint8Array(2);
			payload[0] = (srcNodeUrn.getMac() >> 8) & 255;
			payload[1] = (srcNodeUrn.getMac() >> 0) & 255;

			var packet = PTPacket.create(srcNodeUrn.getMac(), dstNodeUrn.getMac(), payload);
			
			var base64EncodedPacket = btoa(String.fromCharCode.apply(null, packet.buffer));
			var message = {
				payloadBase64 : base64EncodedPacket,
				sourceNodeUrn : srcNodeUrn.nodeUrnString,
				timestamp     : new Date().toISOString(),
				type          : "upstream"
			}

			userScript.onmessage(message);
		}

		var NodeUrn = function(nodeUrnString) {

			this.nodeUrnString = nodeUrnString;

			this.getSuffix = function() {
				return this.nodeUrnString.substring(this.nodeUrnString.lastIndexOf(':') + 1);
			}
			this.getMac = function() {
				return parseInt(this.getSuffix());
			}
		};

		$(function() {

			var isense48Nodes = wiseml.setup.node.filter(function(node) { return node.nodeType == "isense48"; });
			var experimentNodes = isense48Nodes.slice(0, 3);
			var experimentNodesUrns = experimentNodes.map(function(node) { return new NodeUrn(node.id); });
			
			console.log(experimentNodes);

			var totalNumberOfPackets = 30;
			var delay = 200;

			var env = {
				testbedId : 1,
				experimentId : 2,
				outputDiv : $("#DemoCanvas")
			};

			var userScript = new WiseGuiUserScript();
			userScript.start(env);

			var i=0, j=0, k=0;
			var schedule;
			schedule = window.setInterval(function() {

				i = (i == Number.MAX_VALUE) ? 0 : i+1;
				j = i % experimentNodesUrns.length;
				k = (i + 1) % experimentNodesUrns.length;

				sendPacket(userScript, experimentNodesUrns[j], experimentNodesUrns[k]);

				$('#DivPacketCount').html("&nbsp;#&nbsp;" + i + "&nbsp;");

				if (i == totalNumberOfPackets) {
					window.clearInterval(schedule);
					userScript.stop();
				}
				
			}, delay);
		})
	</script>

</head>

<body>
	<div id="DemoCanvas"></div>
	<div id="DivPacketCount"></div>
</body>

</html>