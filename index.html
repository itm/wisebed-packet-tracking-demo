<!DOCTYPE html >
<html>
<head>

	<meta charset="utf-8">

	<title>DDD - Dennis Dolle Demo</title>

	<link rel="stylesheet" media="screen" href="bootstrap.css">
	<style type="text/css">

		body {
			margin: 10px;
		}

		#DivPacketCount {
			position: absolute;
			background-color: black;
			color: white;
			top: 10px;
			right: 10px;
		}

		#DemoCanvas {
			/*background-size: 100% auto;
			background-image: url(floorplan_testbed_uzl.png);
			background-repeat: no-repeat;*/
			border: 1px solid black;
			width: 500px;
			height: 500px;
		}

	</style>

	
	<script type="text/javascript" src="jquery-1.9.1.js"></script>
	<script type="text/javascript" src="bootstrap.js"></script>
	
	<script type="text/javascript" src="pt_packet.js"></script>
	<script type="text/javascript" src="wiseml.js"></script>
	<script type="text/javascript" src="sigma.min.js"></script>

	<script type="text/javascript">
		
		WiseGuiUserScript = function() {
			console.log("WiseGuiUserScript instantiated...");
			this.testbedId = null;
			this.experimentId = null;
			this.webSocket = null;
			this.outputDiv = null;
		};

		WiseGuiUserScript.prototype.start = function(env) {
			
			console.log("Starting user script...");

			this.testbedId = env.testbedId;
			this.experimentId = env.experimentId;
			this.outputDiv = env.outputDiv;

			// TODO: load WiseML from testbed
			console.log(this.outputDiv[0]);
			var graph = sigma.init(this.outputDiv[0]);
			graph.drawingProperties({
    defaultLabelColor: '#fff',
    defaultLabelSize: 14,
    defaultLabelBGColor: '#fff',
    defaultLabelHoverColor: '#000',
    labelThreshold: 6,
    defaultEdgeType: 'curve'
  }).graphProperties({
    minNodeSize: 0.5,
    maxNodeSize: 5,
    minEdgeSize: 1,
    maxEdgeSize: 1
  }).mouseProperties({
    maxRatio: 4
  });
			graph.addNode('hello',{
				label: 'Hello',
				color: '#ff0000'
			}).addNode('world',{
				label: 'World !',
				color: '#00ff00'
			}).addEdge('hello_world','hello','world');

			graph.draw();

			/*
			var self = this;
			this.webSocket = new Wisebed.WebSocket(
			  this.testbedId,
			  this.experimentId,
			  function() {self.onmessage(arguments);},
			  function() {self.onopen(arguments);},
			  function() {self.onclosed(arguments);}
			);
			*/
		};

		WiseGuiUserScript.prototype.stop = function() {
			console.log("Stopping user script...");
			//this.webSocket.close();
		};

		WiseGuiUserScript.prototype.onmessage = function(message) {
			var payload = new Uint8Array(atob(message.payloadBase64).split("").map(function(c) { return c.charCodeAt(0); }));
			var packet = PTPacket.parse(payload);
			console.log(packet.toString());
		};

		WiseGuiUserScript.prototype.onopen = function(event) {
			console.log(event);
		};

		WiseGuiUserScript.prototype.onclosed = function(event) {
			console.log(event);
		};

	</script>

	<script type="text/javascript">

		function sendPacket(userScript, srcNodeUrn, dstNodeUrn) {

			var payload = new Uint8Array(2);
			payload[0] = (srcNodeUrn.getMac() >> 8) & 255;
			payload[1] = (srcNodeUrn.getMac() >> 0) & 255;

			var packet = PTPacket.create(srcNodeUrn.getMac(), dstNodeUrn.getMac(), payload);
			
			var base64EncodedPacket = btoa(String.fromCharCode.apply(null, packet.buffer));
			var message = {
				payloadBase64 : base64EncodedPacket,
				sourceNodeUrn : srcNodeUrn.nodeUrnString,
				timestamp     : new Date().toISOString(),
				type          : "upstream"
			}

			userScript.onmessage(message);
		}

		var NodeUrn = function(nodeUrnString) {

			this.nodeUrnString = nodeUrnString;

			this.getSuffix = function() {
				return this.nodeUrnString.substring(this.nodeUrnString.lastIndexOf(':') + 1);
			}
			this.getMac = function() {
				return parseInt(this.getSuffix());
			}
		};

		$(function() {

			var isense48Nodes = wiseml.setup.node.filter(function(node) { return node.nodeType == "isense48"; });
			var experimentNodes = isense48Nodes.slice(0, 3);
			var experimentNodesUrns = experimentNodes.map(function(node) { return new NodeUrn(node.id); });
			
			console.log(experimentNodes);

			var totalNumberOfPackets = 30;
			var delay = 200;

			var env = {
				testbedId : 1,
				experimentId : 2,
				outputDiv : $("#DemoCanvas")
			};

			var userScript = new WiseGuiUserScript();
			userScript.start(env);

			var i=0, j=0, k=0;
			var schedule;
			schedule = window.setInterval(function() {

				i = (i == Number.MAX_VALUE) ? 0 : i+1;
				j = i % experimentNodesUrns.length;
				k = (i + 1) % experimentNodesUrns.length;

				sendPacket(userScript, experimentNodesUrns[j], experimentNodesUrns[k]);

				$('#DivPacketCount').html("&nbsp;#&nbsp;" + i + "&nbsp;");

				if (i == totalNumberOfPackets) {
					window.clearInterval(schedule);
					userScript.stop();
				}
				
			}, delay);
		})
	</script>

</head>

<body>
	<canvas id="DemoCanvas"></canvas>
	<div id="DivPacketCount"></div>
</body>

</html>