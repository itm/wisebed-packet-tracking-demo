<!DOCTYPE html >
<html>
<head>

	<meta charset="utf-8">

	<title>DDD - Dennis Dolle Demo</title>

	<link rel="stylesheet" media="screen" href="bootstrap.css">
	<style type="text/css">

		body {
			margin: 10px;
		}

		#DivPacketCount {
			position: absolute;
			background-color: black;
			color: white;
			top: 10px;
			right: 10px;
		}

		#DemoCanvas {
			background-size: 100% auto;
			background-image: url(floorplan_testbed_uzl.png);
			background-repeat: no-repeat;
			border: 1px solid black;
			width: 100%;
			height: 1000px;
		}

		rect {
			fill: none;
			pointer-events: all;
		}

		.node {
			fill: #000;
		}

		.link {
			stroke: rgb(0,0,0);
			stroke-width: 4;
		}

		.c0  { stroke: rgb(054,097,171); stroke-width: 4; }
		.c1  { stroke: rgb(186,215,187); stroke-width: 4; }
		.c2  { stroke: rgb(220,150,187); stroke-width: 4; }
		.c3  { stroke: rgb(223,184,043); stroke-width: 4; }
		.c4  { stroke: rgb(251,242,095); stroke-width: 4; }
		.c5  { stroke: rgb(160,155,202); stroke-width: 4; }
		.c6  { stroke: rgb(161,082,042); stroke-width: 4; }
		.c7  { stroke: rgb(216,130,130); stroke-width: 4; }
		.c8  { stroke: rgb(180,204,236); stroke-width: 4; }
		.c9  { stroke: rgb(089,153,080); stroke-width: 4; }
		.c10 { stroke: rgb(151,049,061); stroke-width: 4; }
		.c11 { stroke: rgb(102,053,119); stroke-width: 4; }

		#marker0  { fill: rgb(054,097,171); }
		#marker1  { fill: rgb(186,215,187); }
		#marker2  { fill: rgb(220,150,187); }
		#marker3  { fill: rgb(223,184,043); }
		#marker4  { fill: rgb(251,242,095); }
		#marker5  { fill: rgb(160,155,202); }
		#marker6  { fill: rgb(161,082,042); }
		#marker7  { fill: rgb(216,130,130); }
		#marker8  { fill: rgb(180,204,236); }
		#marker9  { fill: rgb(089,153,080); }
		#marker10 { fill: rgb(151,049,061); }
		#marker11 { fill: rgb(102,053,119); }

	</style>

	
	<script type="text/javascript" src="jquery-1.9.1.js"></script>
	<script type="text/javascript" src="bootstrap.js"></script>

</head>

<body>
	
	<script type="text/javascript" src="app.js"></script>

	<script type="text/javascript">

		var lastTag = 0;

		function sendPacket(userScript, srcNodeUrn, dstNodeUrn, demoIteration) {

			if (demoIteration % 5 == 0) {
				lastTag = (lastTag +1) % Number.MAX_VALUE;
			}

			/*
			var packetBytes = [ 0x6c, 0x21, 0x40, 0x21, 0x24, 0x0, 0x0, 0x0, 0x42, 0x6f, 0x0, 0x5, 0x0, 0xe, 0x20, 0x1, 0x63, 0x80, 0x70, 0xa0, 0xb0, 0x69, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x21, 0x40, 0x20, 0x1, 0x63, 0x80, 0x70, 0xa0, 0xb0, 0x69, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x21, 0x30, 0xf1, 0x0, 0x0, 0xb0, 0x74, 0xe1, 0x54, 0x68, 0x69, 0x73, 0x20, 0x69, 0x73, 0x20, 0x61, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x58, 0x58, 0x58, 0x58, 0x0];
			
			var packet = PTPacket.parse(packetBytes);
			console.log(packet.getSource().toString(16));
			console.log(packet.getDestination().toString(16));
			console.log(packet.getPayload());

			var lowpanPacket = SixLowPanPacket.parse(packet.getPayload());
			console.log(lowpanPacket.toString());
			*/

			var payload = [ 0x6f, 0x0, 0x5, 0x0, 0xe, 0x20, 0x1, 0x63, 0x80, 0x70, 0xa0, 0xb0, 0x69, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x21, 0x40, 0x20, 0x1, 0x63, 0x80, 0x70, 0xa0, 0xb0, 0x69, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x21, 0x30, 0xf1, 0x0, 0x0, 0xb0, 0x74, 0xe1, 0x54, 0x68, 0x69, 0x73, 0x20, 0x69, 0x73, 0x20, 0x61, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x58, 0x58, 0x58, 0x58, 0x0];

			var lowpanPacket = SixLowPanPacket.parse(payload);
			lowpanPacket.setFlowLabel(lastTag);

			var packet = PTPacket.create(srcNodeUrn.getMac(), dstNodeUrn.getMac(), lowpanPacket.buffer);

			console.log(packet.toString());

			var base64EncodedPacket = btoa(String.fromCharCode.apply(null, packet.buffer));
			var message = {
				payloadBase64 : base64EncodedPacket,
				sourceNodeUrn : srcNodeUrn.nodeUrnString,
				timestamp     : new Date().toISOString(),
				type          : "upstream"
			}

			userScript.onmessage(message);
		}

		var NodeUrn = function(nodeUrnString) {

			this.nodeUrnString = nodeUrnString;

			this.getSuffix = function() {
				return this.nodeUrnString.substring(this.nodeUrnString.lastIndexOf(':') + 1);
			}
			this.getMac = function() {
				return parseInt(this.getSuffix());
			}
		};

		$(function() {

			var env = {
				testbedId : 1,
				experimentId : 2,
				outputDiv : $("#DemoCanvas")
			};

			var userScript = new WiseGuiUserScript();
			userScript.start(env);

			var isense48Nodes = wiseml.setup.node.filter(function(node) { return node.nodeType == "isense48"; });
			var experimentNodes = isense48Nodes.slice(0, isense48Nodes.length);
			var experimentNodesUrns = experimentNodes.map(function(node) { return new NodeUrn(node.id); });
			
			console.log(experimentNodes);

			var totalNumberOfPackets = 3000;
			var delay = 500;

			var i=0, j=0, k=0;
			var schedule;
			schedule = window.setInterval(function() {

				i = (i == Number.MAX_VALUE) ? 0 : i+1;
				j = i % experimentNodesUrns.length;
				k = (i + 1) % experimentNodesUrns.length;

				sendPacket(userScript, experimentNodesUrns[j], experimentNodesUrns[k], i);

				$('#DivPacketCount').html("&nbsp;#&nbsp;" + i + "&nbsp;");

				if (i == totalNumberOfPackets) {
					window.clearInterval(schedule);
					userScript.stop();
				}
				
			}, delay);
		})
	</script>

	<div id="DemoCanvas"></div>
	<div id="DivPacketCount"></div>
</body>

</html>